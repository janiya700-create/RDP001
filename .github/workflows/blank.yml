name: Setup Tailscale + RDP

on: [workflow_dispatch]

jobs:
  setup-rdp:
    runs-on: windows-latest
    env:
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Tailscale (if needed)
        shell: pwsh
        run: |
          choco install tailscale -y

      - name: Start Tailscale and get IP
        shell: pwsh
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTHKEY --hostname=gh-runner-$env:GITHUB_RUN_ID
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Setup RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          $RdpUser = "RDP"
          $RdpPass = $env:RDP_PASSWORD
          net user $RdpUser $RdpPass /add
          net localgroup administrators $RdpUser /add
          Set-Service -Name TermService -StartupType Automatic
          Start-Service TermService

      - name: Output Tailscale IP
        run: echo "RDP via Tailscale IP: ${{ env.TAILSCALE_IP }}"
